<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Informe FV ‚Äî Edificio Gorraiz</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0e17; --card: #111827; --accent: #22c55e; --blue: #2980b9;
  --orange: #e67e22; --red: #e74c3c; --border: #1e293b;
  --text: #e2e8f0; --dim: #94a3b8; --muted: #64748b;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'IBM Plex Sans',sans-serif; min-height:100vh; }
.header {
  background:linear-gradient(135deg,#1a5c3a,#0f1a12);
  padding:24px 32px; border-bottom:1px solid rgba(34,197,94,.2);
}
.header h1 {
  font-size:22px; font-weight:800;
  background:linear-gradient(90deg,#22c55e,#86efac);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
}
.header-sub { font-size:13px; color:var(--dim); margin-top:2px; }
.main { max-width:1000px; margin:0 auto; padding:24px; }

/* Steps */
.steps { display:flex; gap:8px; margin-bottom:24px; }
.step {
  flex:1; padding:12px 16px; background:var(--card); border:1px solid var(--border);
  border-radius:10px; text-align:center; opacity:0.5; transition:all .3s;
}
.step.active { opacity:1; border-color:var(--accent); }
.step.done { opacity:1; border-color:#16a34a; background:#0d2818; }
.step-num { font-size:20px; font-weight:800; color:var(--accent); font-family:'JetBrains Mono',monospace; }
.step-label { font-size:11px; color:var(--dim); margin-top:2px; }

/* Upload zones */
.upload-zone {
  background:var(--card); border:2px dashed var(--border); border-radius:12px;
  padding:24px; text-align:center; cursor:pointer; transition:all .2s; margin-bottom:12px;
}
.upload-zone:hover, .upload-zone.dragover { border-color:var(--accent); background:#0d2818; }
.upload-zone.loaded { border-color:#16a34a; border-style:solid; }
.upload-zone h3 { font-size:14px; margin-bottom:4px; }
.upload-zone p { font-size:12px; color:var(--muted); }
.upload-zone .status { font-size:12px; color:var(--accent); margin-top:8px; font-weight:600; }
input[type=file] { display:none; }

/* Date inputs */
.date-row { display:flex; gap:12px; margin-bottom:16px; align-items:center; }
.date-row label { font-size:13px; color:var(--dim); }
.date-row input {
  background:#0d1320; border:1px solid var(--border); border-radius:6px;
  color:var(--text); padding:8px 12px; font-family:inherit; font-size:13px;
}

/* Buttons */
.btn {
  padding:12px 28px; border:none; border-radius:8px; cursor:pointer;
  font-size:14px; font-weight:700; font-family:inherit; transition:all .2s;
}
.btn-primary { background:var(--accent); color:#000; }
.btn-primary:hover { background:#16a34a; }
.btn-primary:disabled { background:#1e293b; color:var(--muted); cursor:not-allowed; }
.btn-pdf { background:var(--blue); color:#fff; margin-left:12px; }
.btn-pdf:hover { background:#1a6fa0; }

/* Results */
.kpi-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:10px; margin:16px 0; }
.kpi-card {
  background:var(--card); border:1px solid var(--border); border-radius:8px;
  padding:12px; border-top:3px solid var(--accent);
}
.kpi-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; }
.kpi-value { font-size:18px; font-weight:700; color:var(--accent); margin-top:4px; font-family:'JetBrains Mono',monospace; }
.kpi-sub { font-size:10px; color:var(--dim); margin-top:2px; }

.chart-container { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:16px; margin:12px 0; }
.chart-title { font-size:13px; font-weight:700; margin-bottom:8px; }

.section-title { font-size:14px; font-weight:700; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin:20px 0 10px; }

#log { font-size:11px; color:var(--muted); font-family:'JetBrains Mono',monospace; max-height:120px; overflow-y:auto; padding:8px; background:#0d1320; border-radius:6px; margin-top:8px; }

/* PDF canvas (hidden) */
#pdf-render { position:absolute; left:-9999px; top:0; width:794px; }
.pdf-page {
  width:794px; height:1123px; background:#fff; padding:24px;
  font-family:'IBM Plex Sans',Arial,sans-serif; color:#333; position:relative;
  page-break-after:always;
}
.pdf-header { background:#1a3c4d; color:#fff; padding:12px 20px; border-radius:6px; margin-bottom:16px; }
.pdf-header h2 { font-size:16px; font-weight:700; }
.pdf-header p { font-size:11px; opacity:.8; }
.pdf-kpi-row { display:flex; gap:8px; margin-bottom:12px; }
.pdf-kpi {
  flex:1; background:#f0f7ff; border:1px solid #d0e0f0; border-radius:6px;
  padding:8px 10px; text-align:center;
}
.pdf-kpi .label { font-size:8px; color:#666; text-transform:uppercase; }
.pdf-kpi .val { font-size:14px; font-weight:700; color:#1a5276; margin-top:2px; }
.pdf-kpi .sub { font-size:8px; color:#999; }
.pdf-footer { position:absolute; bottom:12px; left:24px; right:24px; font-size:8px; color:#999; border-top:1px solid #ddd; padding-top:4px; }
.pdf-table { width:100%; border-collapse:collapse; font-size:10px; margin:8px 0; }
.pdf-table th { background:#1a3c4d; color:#fff; padding:6px 8px; text-align:left; }
.pdf-table td { padding:5px 8px; border-bottom:1px solid #eee; }
.pdf-table tr:nth-child(even) td { background:#f8f9fa; }
.pdf-ficha { background:#f8f9fa; border:1px solid #ddd; border-radius:6px; padding:12px; font-size:10px; }
.pdf-ficha li { margin-bottom:4px; color:#555; }

@media(max-width:700px) {
  .main { padding:12px; }
  .steps { flex-wrap:wrap; }
  .kpi-grid { grid-template-columns:1fr 1fr; }
  .date-row { flex-direction:column; }
}
</style>
</head>
<body>

<div class="header">
  <h1>‚òÄÔ∏è Informe FV ‚Äî Edificio Gorraiz</h1>
  <div class="header-sub">123.84 kWp ¬∑ Autoconsumo SIN excedentes ¬∑ Generador de informes PDF</div>
</div>

<div class="main">
  <!-- Progress steps -->
  <div class="steps">
    <div class="step active" id="s1"><div class="step-num">1</div><div class="step-label">Subir datos</div></div>
    <div class="step" id="s2"><div class="step-num">2</div><div class="step-label">Configurar</div></div>
    <div class="step" id="s3"><div class="step-num">3</div><div class="step-label">Resultados</div></div>
    <div class="step" id="s4"><div class="step-num">4</div><div class="step-label">Descargar PDF</div></div>
  </div>

  <!-- STEP 1: Upload -->
  <div id="panel-upload">
    <div class="upload-zone" id="zone-inv-a" onclick="document.getElementById('file-inv-a').click()">
      <h3>üìÇ Inversor A ‚Äî Ficheros KSTAR (.xlsx)</h3>
      <p>Selecciona uno o varios ficheros .xlsx del inversor A</p>
      <div class="status" id="status-inv-a"></div>
      <input type="file" id="file-inv-a" accept=".xlsx" multiple>
    </div>

    <div class="upload-zone" id="zone-inv-b" onclick="document.getElementById('file-inv-b').click()">
      <h3>üìÇ Inversor B ‚Äî Ficheros KSTAR (.xlsx) <span style="color:var(--muted)">(opcional)</span></h3>
      <p>Selecciona ficheros del inversor B si existe</p>
      <div class="status" id="status-inv-b"></div>
      <input type="file" id="file-inv-b" accept=".xlsx" multiple>
    </div>

    <div class="upload-zone" id="zone-ibr" onclick="document.getElementById('file-ibr').click()">
      <h3>üìÇ Consumo i-DE (.xlsx)</h3>
      <p>Fichero de consumo horario descargado de i-DE (hoja "Horarias")</p>
      <div class="status" id="status-ibr"></div>
      <input type="file" id="file-ibr" accept=".xlsx">
    </div>

    <div class="date-row">
      <label>Desde:</label>
      <input type="date" id="fecha-desde">
      <label>Hasta:</label>
      <input type="date" id="fecha-hasta">
      <span style="font-size:11px;color:var(--muted)">(vac√≠o = todo el rango disponible)</span>
    </div>

    <button class="btn btn-primary" id="btn-generate" onclick="generate()" disabled>
      ‚ö° Generar informe
    </button>
    <div id="log"></div>
  </div>

  <!-- STEP 3: Results -->
  <div id="panel-results" style="display:none">
    <div class="section-title">Resultados clave</div>
    <div class="kpi-grid" id="kpi-grid"></div>

    <div class="chart-container">
      <div class="chart-title">Producci√≥n diaria (kWh)</div>
      <canvas id="chart-daily" height="200"></canvas>
    </div>

    <div style="display:flex;gap:12px">
      <div class="chart-container" style="flex:1">
        <div class="chart-title">Perfil horario medio FV (kWh/h)</div>
        <canvas id="chart-hourly" height="180"></canvas>
      </div>
      <div class="chart-container" style="flex:1">
        <div class="chart-title">Reparto inversores</div>
        <canvas id="chart-donut" height="180"></canvas>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">Consumo diario: Red vs FV (kWh)</div>
      <canvas id="chart-cons" height="200"></canvas>
    </div>

    <div class="chart-container">
      <div class="chart-title">Ahorro por periodos (P1-P6)</div>
      <canvas id="chart-ahorro" height="160"></canvas>
    </div>

    <div style="margin-top:16px">
      <button class="btn btn-pdf" onclick="generatePDF()">üìÑ Descargar PDF</button>
      <button class="btn" style="background:var(--card);color:var(--text);border:1px solid var(--border);margin-left:8px" onclick="reset()">‚Ü© Nuevo informe</button>
    </div>
  </div>
</div>

<!-- Hidden PDF render area -->
<div id="pdf-render"></div>

<script>
// ‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê
const CFG = {
  potencia_kwp: 123.84,
  modalidad: "Autoconsumo SIN excedentes (vertido cero)",
  modulos: "288 m√≥dulos de 430 Wp",
  inversores: "2 √ó 50 kW (KSTAR G50KT)",
  cubierta: "Este-Oeste",
  prod_anual_est: 141793,
  inversion: 80432.64,
  precios: { P1:0.194, P2:0.160, P3:0.160, P4:0.139, P5:0.139, P6:0.139 },
  IE: 0.051127,
  IVA: 0.21,
  factor_emisiones: 0.2,
  consumo_vivienda: 250,
  umbral_pv: 0.1,
};

// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let RAW = { invA: [], invB: [], ibr: [] };
let RESULT = null;

// ‚ïê‚ïê‚ïê LOGGING ‚ïê‚ïê‚ïê
function log(msg) {
  const el = document.getElementById('log');
  el.innerHTML += msg + '<br>';
  el.scrollTop = el.scrollHeight;
}

// ‚ïê‚ïê‚ïê FILE HANDLERS ‚ïê‚ïê‚ïê
document.getElementById('file-inv-a').addEventListener('change', e => loadInversor(e.target.files, 'A'));
document.getElementById('file-inv-b').addEventListener('change', e => loadInversor(e.target.files, 'B'));
document.getElementById('file-ibr').addEventListener('change', e => loadIBR(e.target.files[0]));

function checkReady() {
  const ready = RAW.invA.length > 0 && RAW.ibr.length > 0;
  document.getElementById('btn-generate').disabled = !ready;
}

function parseExcelDate(v) {
  if (v instanceof Date) return v;
  if (typeof v === 'number') {
    // Excel serial date
    const d = new Date((v - 25569) * 86400000);
    return d;
  }
  if (typeof v === 'string') {
    // Try multiple formats
    let d = new Date(v);
    if (!isNaN(d)) return d;
    // DD/MM/YYYY HH:mm
    const m = v.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*(\d{1,2})?:?(\d{2})?:?(\d{2})?/);
    if (m) {
      d = new Date(m[3], m[2]-1, m[1], m[4]||0, m[5]||0, m[6]||0);
      if (!isNaN(d)) return d;
    }
  }
  return null;
}

function loadInversor(files, label) {
  const key = label === 'A' ? 'invA' : 'invB';
  RAW[key] = [];
  let loaded = 0;
  const total = files.length;

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { defval: 0 });

        rows.forEach(row => {
          // Find columns
          let ts = null, pot = 0, acum = 0, diaria = 0;
          for (const [k, v] of Object.entries(row)) {
            const kl = k.toLowerCase();
            if (kl.includes('tiempo') || kl === 'tiempo') ts = parseExcelDate(v);
            if (kl.includes('potencia total c') || kl.includes('potencia total ac')) pot = parseFloat(v) || 0;
            if (kl.includes('producci√≥n acumulada') || kl.includes('produccion acumulada')) acum = parseFloat(v) || 0;
            if (kl.includes('producci√≥n diaria') || kl.includes('produccion diaria')) diaria = parseFloat(v) || 0;
          }
          if (ts) RAW[key].push({ ts, pot, acum, diaria });
        });
      } catch(err) {
        log(`‚ö† Error leyendo ${file.name}: ${err.message}`);
      }
      loaded++;
      if (loaded === total) {
        RAW[key].sort((a,b) => a.ts - b.ts);
        const days = new Set(RAW[key].map(r => r.ts.toDateString())).size;
        document.getElementById(`status-inv-${label.toLowerCase()}`).textContent =
          `‚úì ${total} fichero(s), ${RAW[key].length} registros, ${days} d√≠as`;
        document.getElementById(`zone-inv-${label.toLowerCase()}`).classList.add('loaded');
        log(`Inversor ${label}: ${RAW[key].length} registros, ${days} d√≠as`);
        checkReady();
      }
    };
    reader.readAsArrayBuffer(file);
  });
}

function loadIBR(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
      // Find "Horarias" sheet
      let sheetName = wb.SheetNames.find(s => s.toLowerCase().includes('horaria')) || wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

      // Find header row (look for "Fecha" or "Consumo")
      let headerRow = 2; // default for i-DE format
      for (let i = 0; i < Math.min(10, rows.length); i++) {
        const r = rows[i].map(c => String(c).toLowerCase());
        if (r.some(c => c.includes('fecha') || c.includes('consumo'))) { headerRow = i; break; }
      }

      RAW.ibr = [];
      for (let i = headerRow + 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r || r.length < 5) continue;
        const ts = parseExcelDate(r[1]); // Column B = timestamp
        if (!ts) continue;
        const consumo = (parseFloat(r[4]) || 0) / 1000; // Column E = Wh ‚Üí kWh
        const gen = (parseFloat(r[5]) || 0) / 1000; // Column F = generation Wh ‚Üí kWh
        // Period: column D
        let periodo = 'P6';
        const rawP = String(r[3] || '');
        const pm = rawP.match(/(\d)/);
        if (pm) periodo = 'P' + pm[1];
        RAW.ibr.push({ ts, consumo, gen, periodo });
      }
      RAW.ibr.sort((a,b) => a.ts - b.ts);
      const days = new Set(RAW.ibr.map(r => r.ts.toDateString())).size;
      document.getElementById('status-ibr').textContent =
        `‚úì ${RAW.ibr.length} registros, ${days} d√≠as`;
      document.getElementById('zone-ibr').classList.add('loaded');
      log(`Consumo i-DE: ${RAW.ibr.length} registros, ${days} d√≠as`);
      checkReady();
    } catch(err) {
      log(`‚ö† Error leyendo consumo: ${err.message}`);
    }
  };
  reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê‚ïê PROCESSING ENGINE ‚ïê‚ïê‚ïê
function dateKey(d) { return d.toISOString().slice(0,10); }
function hourKey(d) { return d.toISOString().slice(0,13); }
function fmtNum(n) { return n.toLocaleString('es-ES', {maximumFractionDigits:0}); }
function fmtDec(n,d=1) { return n.toLocaleString('es-ES', {minimumFractionDigits:d,maximumFractionDigits:d}); }

function filterByDate(arr, desde, hasta) {
  return arr.filter(r => {
    if (desde && r.ts < desde) return false;
    if (hasta && r.ts > hasta) return false;
    return true;
  });
}

function processProduction(invA, invB) {
  // Daily aggregation
  const dailyMap = {};
  invA.forEach(r => {
    const dk = dateKey(r.ts);
    if (!dailyMap[dk]) dailyMap[dk] = { date: dk, invA: 0, invB: 0 };
    dailyMap[dk].invA = Math.max(dailyMap[dk].invA, r.diaria);
  });
  invB.forEach(r => {
    const dk = dateKey(r.ts);
    if (!dailyMap[dk]) dailyMap[dk] = { date: dk, invA: 0, invB: 0 };
    dailyMap[dk].invB = Math.max(dailyMap[dk].invB, r.diaria);
  });
  const daily = Object.values(dailyMap).map(d => ({
    ...d, total: d.invA + d.invB
  })).sort((a,b) => a.date.localeCompare(b.date));

  // Hourly aggregation (for profile)
  const hourlyMap = {};
  const processHourly = (arr, key) => {
    const sorted = [...arr].sort((a,b) => a.ts - b.ts);
    sorted.forEach(r => {
      const hk = hourKey(r.ts);
      if (!hourlyMap[hk]) hourlyMap[hk] = { hour: hk, h: r.ts.getHours(), invA: 0, invB: 0 };
    });
    // Group by hour, compute delta acum
    const byHour = {};
    sorted.forEach(r => {
      const hk = hourKey(r.ts);
      if (!byHour[hk]) byHour[hk] = [];
      byHour[hk].push(r);
    });
    for (const [hk, recs] of Object.entries(byHour)) {
      if (recs.length < 2) {
        if (hourlyMap[hk]) hourlyMap[hk][key] = (recs[0].pot || 0) / 1000;
      } else {
        let delta = recs[recs.length-1].acum - recs[0].acum;
        if (delta <= 0) delta = recs.reduce((s,r) => s + r.pot, 0) / recs.length / 1000;
        if (hourlyMap[hk]) hourlyMap[hk][key] = Math.max(0, delta);
      }
    }
  };
  processHourly(invA, 'invA');
  processHourly(invB, 'invB');

  const hourly = Object.values(hourlyMap).map(h => ({
    ...h, total: h.invA + h.invB
  })).sort((a,b) => a.hour.localeCompare(b.hour));

  return { daily, hourly };
}

function processConsumption(ibr, prodHourly) {
  // Build PV lookup by hour
  const pvByHour = {};
  prodHourly.forEach(h => { pvByHour[h.hour] = h.total; });

  const consHourly = ibr.map(r => {
    const hk = hourKey(r.ts);
    const pvKwh = pvByHour[hk] || 0;
    return {
      ts: r.ts, date: dateKey(r.ts), h: r.ts.getHours(),
      red: r.consumo, gen: r.gen, pv: pvKwh,
      total: r.consumo + pvKwh, periodo: r.periodo,
      weekday: r.ts.getDay(), // 0=Sun
    };
  });

  // Daily
  const dailyMap = {};
  consHourly.forEach(r => {
    if (!dailyMap[r.date]) dailyMap[r.date] = { date: r.date, total: 0, red: 0, pv: 0 };
    dailyMap[r.date].total += r.total;
    dailyMap[r.date].red += r.red;
    dailyMap[r.date].pv += r.pv;
  });
  const consDaily = Object.values(dailyMap).sort((a,b) => a.date.localeCompare(b.date));

  return { hourly: consHourly, daily: consDaily };
}

function calcKPIs(prod, cons) {
  const pd = prod.daily;
  const ch = cons.hourly;

  // Production KPIs
  const totalProd = pd.reduce((s,d) => s + d.total, 0);
  const daysWithPV = pd.filter(d => d.total > 0).length;
  const avgDaily = daysWithPV > 0 ? totalProd / daysWithPV : 0;
  const bestDay = pd.reduce((m,d) => d.total > m.total ? d : m, { total:0, date:'-' });
  const yieldKwp = totalProd / CFG.potencia_kwp;
  const invATotal = pd.reduce((s,d) => s + d.invA, 0);
  const invBTotal = pd.reduce((s,d) => s + d.invB, 0);

  // Savings by period
  const ahorroPeriodos = {};
  ['P1','P2','P3','P4','P5','P6'].forEach(p => { ahorroPeriodos[p] = { kwh: 0, precio: CFG.precios[p], ahorro: 0 }; });
  ch.forEach(r => {
    const p = r.periodo || 'P6';
    if (ahorroPeriodos[p]) ahorroPeriodos[p].kwh += r.pv;
  });
  let totalAhorroEnergia = 0;
  for (const p in ahorroPeriodos) {
    ahorroPeriodos[p].ahorro = ahorroPeriodos[p].kwh * ahorroPeriodos[p].precio;
    totalAhorroEnergia += ahorroPeriodos[p].ahorro;
  }
  const totalAhorroFactura = totalAhorroEnergia * (1 + CFG.IE) * (1 + CFG.IVA);

  // Consumption KPIs
  const totalCons = ch.reduce((s,r) => s + r.total, 0);
  const totalRed = ch.reduce((s,r) => s + r.red, 0);
  const totalPV = ch.reduce((s,r) => s + r.pv, 0);
  const pctCubierto = totalCons > 0 ? (totalPV / totalCons * 100) : 0;

  // Hourly profile for chart
  const hourlyProfile = Array(24).fill(0).map(() => ({ count: 0, total: 0 }));
  prod.hourly.forEach(h => { hourlyProfile[h.h].total += h.total; hourlyProfile[h.h].count++; });
  const avgHourly = hourlyProfile.map(h => h.count > 0 ? h.total / h.count : 0);

  // Payback
  const ahorroAnual = daysWithPV > 0 ? totalAhorroFactura * 365 / daysWithPV : 0;
  const paybackYears = ahorroAnual > 0 ? CFG.inversion / ahorroAnual : 99;

  return {
    totalProd, daysWithPV, avgDaily, bestDay,
    yieldKwp, invATotal, invBTotal,
    ahorroPeriodos, totalAhorroEnergia, totalAhorroFactura,
    totalCons, totalRed, totalPV, pctCubierto,
    avgHourly, ahorroAnual, paybackYears,
    co2: totalProd * CFG.factor_emisiones / 1000,
    prod, cons,
  };
}

// ‚ïê‚ïê‚ïê MAIN GENERATE ‚ïê‚ïê‚ïê
function generate() {
  log('Procesando...');
  const desde = document.getElementById('fecha-desde').value ? new Date(document.getElementById('fecha-desde').value + 'T00:00:00') : null;
  const hasta = document.getElementById('fecha-hasta').value ? new Date(document.getElementById('fecha-hasta').value + 'T23:59:59') : null;

  if (desde && hasta && desde > hasta) {
    log('‚ö† ERROR: "Desde" es posterior a "Hasta"');
    return;
  }

  const invA = filterByDate(RAW.invA, desde, hasta);
  const invB = filterByDate(RAW.invB, desde, hasta);
  const ibr = filterByDate(RAW.ibr, desde, hasta);

  log(`Filtrado: Inv A=${invA.length}, Inv B=${invB.length}, IBR=${ibr.length}`);

  if (invA.length === 0) { log('‚ö† No hay datos de inversor A en el rango'); return; }

  const prod = processProduction(invA, invB);
  const cons = processConsumption(ibr, prod.hourly);
  RESULT = calcKPIs(prod, cons);

  log(`‚úì Producci√≥n: ${fmtDec(RESULT.totalProd)} kWh | Consumo: ${fmtNum(RESULT.totalCons)} kWh`);
  log(`‚úì Ahorro energ√≠a: ${fmtNum(RESULT.totalAhorroEnergia)} ‚Ç¨ | Total factura: ${fmtNum(RESULT.totalAhorroFactura)} ‚Ç¨`);

  setStep(3);
  renderResults();
}

// ‚ïê‚ïê‚ïê RENDER RESULTS ‚ïê‚ïê‚ïê
function renderResults() {
  const R = RESULT;
  document.getElementById('panel-upload').style.display = 'none';
  document.getElementById('panel-results').style.display = 'block';

  // KPIs
  const eStr = R.totalProd >= 1000 ? fmtDec(R.totalProd/1000,2) + ' MWh' : fmtDec(R.totalProd) + ' kWh';
  const kpis = [
    { label: 'Energ√≠a producida', value: eStr, sub: 'Producci√≥n total' },
    { label: 'Media diaria', value: fmtDec(R.avgDaily) + ' kWh/d√≠a', sub: R.daysWithPV + ' d√≠as' },
    { label: 'Mejor d√≠a', value: fmtDec(R.bestDay.total) + ' kWh', sub: R.bestDay.date },
    { label: 'Rendimiento', value: fmtDec(R.yieldKwp) + ' kWh/kWp', sub: CFG.potencia_kwp + ' kWp' },
    { label: 'Ahorro energ√≠a', value: fmtNum(R.totalAhorroEnergia) + ' ‚Ç¨', sub: 'P1-P6' },
    { label: 'Ahorro factura', value: fmtNum(R.totalAhorroFactura) + ' ‚Ç¨', sub: 'IE+IVA incl.' },
  ];
  document.getElementById('kpi-grid').innerHTML = kpis.map(k =>
    `<div class="kpi-card"><div class="kpi-label">${k.label}</div><div class="kpi-value">${k.value}</div><div class="kpi-sub">${k.sub}</div></div>`
  ).join('');

  // Charts
  renderDailyChart();
  renderHourlyChart();
  renderDonutChart();
  renderConsChart();
  renderAhorroChart();
}

function renderDailyChart() {
  const ctx = document.getElementById('chart-daily').getContext('2d');
  const pd = RESULT.prod.daily;
  new Chart(ctx, {
    type: pd.length <= 5 ? 'bar' : 'line',
    data: {
      labels: pd.map(d => d.date.slice(5)),
      datasets: [{
        label: 'Producci√≥n (kWh)',
        data: pd.map(d => d.total),
        backgroundColor: '#2980b9',
        borderColor: '#2980b9',
        borderWidth: 1.5,
        fill: false,
        tension: 0.3,
        pointRadius: pd.length > 20 ? 0 : 3,
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderHourlyChart() {
  const ctx = document.getElementById('chart-hourly').getContext('2d');
  const colors = RESULT.avgHourly.map(v => v > Math.max(...RESULT.avgHourly) * 0.5 ? '#2980b9' : '#90caf9');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: Array.from({length:24}, (_,i) => i+'h'),
      datasets: [{ data: RESULT.avgHourly, backgroundColor: colors, borderWidth: 0 }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
}

function renderDonutChart() {
  const ctx = document.getElementById('chart-donut').getContext('2d');
  const a = RESULT.invATotal, b = RESULT.invBTotal;
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Inversor A', 'Inversor B'],
      datasets: [{ data: [a, b], backgroundColor: ['#2980b9', '#e67e22'], borderWidth: 2, borderColor: '#111827' }]
    },
    options: { responsive: true, cutout: '55%', plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 11 } } } } }
  });
}

function renderConsChart() {
  const ctx = document.getElementById('chart-cons').getContext('2d');
  const cd = RESULT.cons.daily;
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: cd.map(d => d.date.slice(5)),
      datasets: [
        { label: 'Red', data: cd.map(d => d.red), backgroundColor: '#e74c3c', stack: 'a' },
        { label: 'FV', data: cd.map(d => d.pv), backgroundColor: '#27ae60', stack: 'a' },
      ]
    },
    options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
  });
}

function renderAhorroChart() {
  const ctx = document.getElementById('chart-ahorro').getContext('2d');
  const ap = RESULT.ahorroPeriodos;
  const periodos = Object.keys(ap);
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: periodos,
      datasets: [
        { label: 'kWh FV', data: periodos.map(p => ap[p].kwh), backgroundColor: '#2980b9', yAxisID: 'y' },
        { label: 'Ahorro ‚Ç¨', data: periodos.map(p => ap[p].ahorro), backgroundColor: '#27ae60', yAxisID: 'y1' },
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, position: 'left', title: { display: true, text: 'kWh' } },
        y1: { beginAtZero: true, position: 'right', title: { display: true, text: '‚Ç¨' }, grid: { drawOnChartArea: false } }
      }
    }
  });
}

// ‚ïê‚ïê‚ïê PDF GENERATION ‚ïê‚ïê‚ïê
async function generatePDF() {
  setStep(4);
  log('Generando PDF...');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('p', 'mm', 'a4');
  const R = RESULT;
  const W = 210, H = 297, M = 15;

  const desde = R.prod.daily[0]?.date || '';
  const hasta = R.prod.daily[R.prod.daily.length-1]?.date || '';
  const periodo = `${desde} ‚Üí ${hasta}`;

  function header(title, sub) {
    doc.setFillColor(26, 60, 77);
    doc.roundedRect(M, 10, W-2*M, 18, 3, 3, 'F');
    doc.setTextColor(255); doc.setFontSize(13); doc.setFont(undefined, 'bold');
    doc.text(title, M+5, 21);
    doc.setFontSize(9); doc.setFont(undefined, 'normal');
    doc.text(sub, M+5, 26);
    doc.setTextColor(0);
  }

  function footer(page) {
    doc.setFontSize(7); doc.setTextColor(150);
    doc.text(`Fuentes: inversores (KSTAR) + contador horario + factura Goiener.  Modalidad: SIN excedentes (vertido cero).`, M, H-8);
    doc.text(`P√°g ${page}`, W-M-10, H-8);
    doc.setTextColor(0);
  }

  // Helper: capture chart to image
  async function chartToImg(canvasId, w, h) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    return canvas.toDataURL('image/png');
  }

  // ‚ïê‚ïê‚ïê PAGE 1: Production ‚ïê‚ïê‚ïê
  header('Producci√≥n fotovoltaica ‚Äî Edificio Gorraiz', `Periodo: ${periodo}  ¬∑  Modalidad: ${CFG.modalidad}`);

  // KPIs
  let y = 34;
  doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Resultados clave', M, y); y += 6;
  const eStr = R.totalProd >= 1000 ? fmtDec(R.totalProd/1000,2) + ' MWh' : fmtDec(R.totalProd) + ' kWh';
  const kpiData = [
    ['Energ√≠a producida', eStr],
    ['Media diaria', fmtDec(R.avgDaily) + ' kWh/d√≠a'],
    ['Mejor d√≠a', fmtDec(R.bestDay.total) + ' kWh'],
    ['Rendimiento', fmtDec(R.yieldKwp) + ' kWh/kWp'],
    ['Ahorro energ√≠a', fmtNum(R.totalAhorroEnergia) + ' ‚Ç¨'],
    ['Ahorro factura', fmtNum(R.totalAhorroFactura) + ' ‚Ç¨'],
  ];
  const kw = (W - 2*M) / 6;
  kpiData.forEach(([label, val], i) => {
    const x = M + i * kw;
    doc.setFillColor(240, 247, 255); doc.roundedRect(x, y, kw-2, 16, 2, 2, 'F');
    doc.setFontSize(6); doc.setFont(undefined, 'normal'); doc.setTextColor(100);
    doc.text(label.toUpperCase(), x+2, y+5);
    doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.setTextColor(26, 82, 118);
    doc.text(val, x+2, y+12);
  });
  doc.setTextColor(0); y += 22;

  // Daily chart
  const imgDaily = await chartToImg('chart-daily');
  if (imgDaily) doc.addImage(imgDaily, 'PNG', M, y, W-2*M, 70);
  y += 76;

  // Conclusion
  doc.setFillColor(248,249,250); doc.roundedRect(M, y, W-2*M, 28, 2, 2, 'F');
  doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text('Conclusi√≥n', M+4, y+7);
  doc.setFontSize(8); doc.setFont(undefined, 'normal'); doc.setTextColor(80);
  const conclusion = `La planta produce con estabilidad. El ahorro se calcula cruzando producci√≥n horaria y precios por periodo (P1-P6). Referencia de proyecto (memoria visada): ${fmtNum(CFG.prod_anual_est)} kWh/a√±o.`;
  doc.text(conclusion, M+4, y+14, { maxWidth: W-2*M-8 });
  doc.setTextColor(0);
  footer(1);

  // ‚ïê‚ïê‚ïê PAGE 2: Inverters & Savings ‚ïê‚ïê‚ïê
  doc.addPage();
  header('Detalle de instalaci√≥n, inversores y ahorro', `Periodo: ${periodo}  ¬∑  Modalidad: ${CFG.modalidad}`);
  y = 34;

  // Hourly profile chart
  const imgHourly = await chartToImg('chart-hourly');
  if (imgHourly) doc.addImage(imgHourly, 'PNG', M, y, (W-2*M)/2-2, 50);

  // Donut chart
  const imgDonut = await chartToImg('chart-donut');
  if (imgDonut) doc.addImage(imgDonut, 'PNG', W/2+2, y, (W-2*M)/2-2, 50);
  y += 56;

  // P1-P6 savings table
  doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text('Ahorro por periodos (P1-P6)', M, y); y += 6;
  doc.setFontSize(8); doc.setFont(undefined, 'bold');
  doc.setFillColor(26,60,77); doc.setTextColor(255);
  doc.rect(M, y, W-2*M, 6, 'F');
  doc.text('Periodo', M+2, y+4); doc.text('FV (kWh)', M+35, y+4);
  doc.text('‚Ç¨/kWh', M+70, y+4); doc.text('Ahorro (‚Ç¨)', M+105, y+4);
  doc.setTextColor(0); doc.setFont(undefined, 'normal'); y += 7;
  const ap = R.ahorroPeriodos;
  let totalAh = 0;
  for (const p of ['P1','P2','P3','P4','P5','P6']) {
    doc.text(p, M+2, y+4);
    doc.text(fmtNum(ap[p].kwh), M+35, y+4);
    doc.text(ap[p].precio.toFixed(3), M+70, y+4);
    doc.text(fmtNum(ap[p].ahorro), M+105, y+4);
    totalAh += ap[p].ahorro;
    if (['P1','P3','P5'].includes(p)) { doc.setFillColor(248,249,250); doc.rect(M, y, W-2*M, 6, 'F'); }
    doc.text(p, M+2, y+4);
    doc.text(fmtNum(ap[p].kwh), M+35, y+4);
    doc.text(ap[p].precio.toFixed(3), M+70, y+4);
    doc.text(fmtNum(ap[p].ahorro), M+105, y+4);
    y += 6;
  }
  doc.setDrawColor(0); doc.line(M, y, W-M, y); y += 2;
  doc.setFont(undefined, 'bold');
  doc.text('TOTAL t√©rmino energ√≠a', M+2, y+4);
  doc.text(fmtNum(totalAh) + ' ‚Ç¨', M+105, y+4);
  y += 12;

  // Ficha
  doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text('Ficha r√°pida de la instalaci√≥n', M, y); y += 5;
  doc.setFillColor(248,249,250); doc.roundedRect(M, y, W-2*M, 44, 2, 2, 'F');
  doc.setFontSize(8); doc.setFont(undefined, 'normal');
  const ficha = [
    `Potencia pico: ${CFG.potencia_kwp} kWp`, `Generadores: ${CFG.modulos}`,
    `Inversores: ${CFG.inversores}`, `Cubierta con captaci√≥n ${CFG.cubierta}`,
    CFG.modalidad, `Producci√≥n anual estimada: ${fmtNum(CFG.prod_anual_est)} kWh/a√±o`,
  ];
  ficha.forEach((line, i) => { doc.text('‚Ä¢ ' + line, M+4, y+6+i*6); });
  footer(2);

  // ‚ïê‚ïê‚ïê PAGE 3: Consumption ‚ïê‚ïê‚ïê
  doc.addPage();
  header('Consumo el√©ctrico y cobertura fotovoltaica', `Periodo: ${periodo}  ¬∑  Modalidad: ${CFG.modalidad}`);
  y = 34;

  // Consumption KPIs
  doc.setFontSize(11); doc.setFont(undefined, 'bold'); doc.text('Balance energ√©tico', M, y); y += 6;
  const consKpis = [
    ['Consumo total', fmtNum(R.totalCons) + ' kWh'],
    ['Desde red', fmtNum(R.totalRed) + ' kWh'],
    ['Desde FV', fmtNum(R.totalPV) + ' kWh'],
    ['Cobertura FV', fmtDec(R.pctCubierto) + '%'],
  ];
  const ckw = (W-2*M) / 4;
  consKpis.forEach(([label, val], i) => {
    const x = M + i * ckw;
    doc.setFillColor(240, 247, 255); doc.roundedRect(x, y, ckw-2, 14, 2, 2, 'F');
    doc.setFontSize(6); doc.setFont(undefined, 'normal'); doc.setTextColor(100);
    doc.text(label.toUpperCase(), x+2, y+5);
    doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.setTextColor(26, 82, 118);
    doc.text(val, x+2, y+11);
  });
  doc.setTextColor(0); y += 20;

  // Consumption chart
  const imgCons = await chartToImg('chart-cons');
  if (imgCons) doc.addImage(imgCons, 'PNG', M, y, W-2*M, 70);
  y += 76;

  // Ahorro chart
  const imgAhorro = await chartToImg('chart-ahorro');
  if (imgAhorro) doc.addImage(imgAhorro, 'PNG', M, y, W-2*M, 55);

  footer(3);

  // Save
  const fname = `Informe_FV_Gorraiz_${desde.replace(/-/g,'')}_${hasta.replace(/-/g,'')}.pdf`;
  doc.save(fname);
  log(`‚úì PDF descargado: ${fname}`);
}

// ‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê
function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('s'+i);
    el.classList.remove('active', 'done');
    if (i < n) el.classList.add('done');
    if (i === n) el.classList.add('active');
  }
}

function reset() {
  RAW = { invA: [], invB: [], ibr: [] };
  RESULT = null;
  document.getElementById('panel-results').style.display = 'none';
  document.getElementById('panel-upload').style.display = 'block';
  document.getElementById('log').innerHTML = '';
  ['inv-a','inv-b','ibr'].forEach(id => {
    document.getElementById('status-'+id).textContent = '';
    document.getElementById('zone-'+id).classList.remove('loaded');
  });
  document.getElementById('btn-generate').disabled = true;
  setStep(1);
}

// Drag & drop support
document.querySelectorAll('.upload-zone').forEach(zone => {
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
  zone.addEventListener('drop', e => {
    e.preventDefault(); zone.classList.remove('dragover');
    const input = zone.querySelector('input[type=file]');
    if (input && e.dataTransfer.files.length) {
      input.files = e.dataTransfer.files;
      input.dispatchEvent(new Event('change'));
    }
  });
});
</script>
</body>
</html>
